name: NEXT Deploy
on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2

      - name: Install Dependencies
        run: |
          yarn install

      - name: Build Next.js app
        run: |
          yarn build

      - name: Archive production artifacts
        run: |
          tar -czf next-app.tar.gz .next package.json yarn.lock

      - name: Upload production artifacts
        uses: actions/upload-artifact@v2
        with:
          name: next-app
          path: next-app.tar.gz

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download production artifacts
        uses: actions/download-artifact@v2
        with:
          name: next-app
          path: .

      - name: Extract production artifacts
        run: |
          tar -xzf next-app.tar.gz

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Copy files via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          scp -o StrictHostKeyChecking=no -i $SSH_PRIVATE_KEY next-app.tar.gz ec2-user@<EC2_INSTANCE_PUBLIC_IP>:/home/ec2-user/

      - name: Connect to EC2 and deploy
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          ssh -o StrictHostKeyChecking=no -i $SSH_PRIVATE_KEY ec2-user@<EC2_INSTANCE_PUBLIC_IP> << 'EOF'
            cd /home/ec2-user
            tar -xzf next-app.tar.gz
            cd /home/ec2-user/next-app
            yarn install --production
            pm2 restart all || pm2 start npm --name "next-app" -- start
          EOF
